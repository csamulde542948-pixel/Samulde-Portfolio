<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Event RSVP Admin Dashboard</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="styles.css">
    
    <style>
        body {
            background: #f8f9fa;
            font-family: 'Poppins', sans-serif;
        }
        
        .admin-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
        }
        
        .stat-card i {
            font-size: 2.5rem;
            margin-bottom: 1rem;
        }
        
        .stat-card.total {
            border-left: 4px solid #667eea;
        }
        
        .stat-card.attending {
            border-left: 4px solid #28a745;
        }
        
        .stat-card.not-attending {
            border-left: 4px solid #dc3545;
        }
        
        .stat-card.recent {
            border-left: 4px solid #ffc107;
        }
        
        .rsvp-table-container {
            background: white;
            border-radius: 10px;
            padding: 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .table-actions {
            margin-bottom: 1.5rem;
        }
        
        .search-box {
            max-width: 300px;
        }
        
        .badge-attending {
            background: #28a745;
        }
        
        .badge-not-attending {
            background: #dc3545;
        }
        
        .btn-export {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
        }
        
        .btn-export:hover {
            background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
            color: white;
        }
        
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #6c757d;
        }
        
        .empty-state i {
            font-size: 4rem;
            margin-bottom: 1rem;
        }
        
        @media (max-width: 768px) {
            .table-responsive {
                font-size: 0.875rem;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="admin-header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h1><i class="fas fa-chart-line me-2"></i>RSVP Dashboard</h1>
                    <p class="mb-0">Startup Hackathon - Admin Panel</p>
                </div>
                <div class="col-md-6 text-md-end mt-3 mt-md-0">
                    <a href="index.html" class="btn btn-light me-2">
                        <i class="fas fa-home me-1"></i>Home
                    </a>
                    <a href="event.html" class="btn btn-outline-light">
                        <i class="fas fa-calendar me-1"></i>Event Page
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="container mb-4">
        <div class="row g-4">
            <div class="col-md-6 col-lg-3">
                <div class="stat-card total">
                    <i class="fas fa-users text-primary"></i>
                    <h3 id="totalRsvps">0</h3>
                    <p class="text-muted mb-0">Total RSVPs</p>
                </div>
            </div>
            <div class="col-md-6 col-lg-3">
                <div class="stat-card attending">
                    <i class="fas fa-check-circle text-success"></i>
                    <h3 id="attendingCount">0</h3>
                    <p class="text-muted mb-0">Attending</p>
                </div>
            </div>
            <div class="col-md-6 col-lg-3">
                <div class="stat-card not-attending">
                    <i class="fas fa-times-circle text-danger"></i>
                    <h3 id="notAttendingCount">0</h3>
                    <p class="text-muted mb-0">Not Attending</p>
                </div>
            </div>
            <div class="col-md-6 col-lg-3">
                <div class="stat-card recent">
                    <i class="fas fa-clock text-warning"></i>
                    <h3 id="recentCount">0</h3>
                    <p class="text-muted mb-0">Last 24 Hours</p>
                </div>
            </div>
        </div>
    </div>

    <!-- RSVP Table -->
    <div class="container mb-5">
        <div class="rsvp-table-container">
            <div class="table-actions d-flex flex-wrap justify-content-between align-items-center">
                <div class="mb-3 mb-md-0">
                    <h4 class="mb-0"><i class="fas fa-list me-2"></i>All RSVPs</h4>
                    <small class="text-muted">
                        Email Status: 
                        <span class="badge bg-success"><i class="fas fa-check-circle"></i> Sent</span>
                        <span class="badge bg-danger"><i class="fas fa-times-circle"></i> Failed</span>
                        <span class="badge bg-secondary"><i class="fas fa-question-circle"></i> Unknown</span>
                    </small>
                </div>
                <div class="d-flex gap-2 flex-wrap">
                    <input type="text" id="searchBox" class="form-control search-box" placeholder="Search...">
                    <select id="filterAttendance" class="form-select" style="max-width: 200px;">
                        <option value="all">All Attendance</option>
                        <option value="yes">Attending</option>
                        <option value="no">Not Attending</option>
                    </select>
                    <select id="filterEmailStatus" class="form-select" style="max-width: 200px;">
                        <option value="all">All Email Status</option>
                        <option value="sent">Email Sent</option>
                        <option value="failed">Email Failed</option>
                        <option value="pending">No Email</option>
                    </select>
                    <button class="btn btn-success" onclick="showBulkEmailModal()">
                        <i class="fas fa-envelope me-1"></i>Send All Emails
                    </button>
                    <button class="btn btn-export" onclick="exportToCSV()">
                        <i class="fas fa-download me-1"></i>Export CSV
                    </button>
                    <button class="btn btn-danger" onclick="clearAllRSVPs()">
                        <i class="fas fa-trash me-1"></i>Clear All
                    </button>
                </div>
            </div>

            <div id="emptyState" class="empty-state d-none">
                <i class="fas fa-inbox"></i>
                <h4>No RSVPs Yet</h4>
                <p>RSVPs will appear here once people start registering for the event.</p>
                <a href="event.html" class="btn btn-primary">
                    <i class="fas fa-plus me-1"></i>Go to Event Page
                </a>
            </div>

            <div id="tableContainer">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>#</th>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Company</th>
                                <th>Role</th>
                                <th>Attending</th>
                                <th>Email Sent</th>
                                <th>Message</th>
                                <th>Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="rsvpTableBody">
                            <!-- Data will be populated here -->
                        </tbody>
                    </table>
                </div>
                <div id="noResults" class="text-center py-4 d-none">
                    <p class="text-muted">No results found matching your search.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Email Preview Modal -->
    <div class="modal fade" id="emailModal" tabindex="-1" aria-labelledby="emailModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="emailModalLabel">
                        <i class="fas fa-envelope me-2"></i>Email Preview
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info mb-3">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Note:</strong> Copy this email content and send it manually via your email client, or use the "mailto" link to open in your default email app.
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">To:</label>
                        <input type="text" id="emailTo" class="form-control" readonly>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">Subject:</label>
                        <input type="text" id="emailSubject" class="form-control" readonly>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">Message:</label>
                        <div id="emailPreview" class="border rounded p-3" style="background: #f8f9fa; max-height: 400px; overflow-y: auto;">
                            <!-- Email content will be inserted here -->
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-info" onclick="copyEmailToClipboard()">
                        <i class="fas fa-copy me-1"></i>Copy to Clipboard
                    </button>
                    <button type="button" class="btn btn-primary" onclick="openInEmailClient()">
                        <i class="fas fa-external-link-alt me-1"></i>Open in Email Client
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        let allRsvps = [];
        let filteredRsvps = [];

        // Load RSVPs from localStorage
        function loadRsvps() {
            try {
                allRsvps = JSON.parse(localStorage.getItem('rsvps') || '[]');
                filteredRsvps = [...allRsvps];
                updateStats();
                renderTable();
            } catch (e) {
                console.error('Error loading RSVPs:', e);
                allRsvps = [];
                filteredRsvps = [];
            }
        }

        // Update statistics
        function updateStats() {
            const total = allRsvps.length;
            const attending = allRsvps.filter(r => r.attend === 'yes').length;
            const notAttending = allRsvps.filter(r => r.attend === 'no').length;
            
            // Count RSVPs in last 24 hours
            const oneDayAgo = new Date(Date.now() - 24 * 60 * 60 * 1000);
            const recent = allRsvps.filter(r => new Date(r.timestamp) > oneDayAgo).length;
            
            // Count emails sent (only for attending)
            const attendingRsvps = allRsvps.filter(r => r.attend === 'yes');
            const emailsSent = attendingRsvps.filter(r => r.emailSent === true).length;

            document.getElementById('totalRsvps').textContent = total;
            document.getElementById('attendingCount').textContent = attending;
            document.getElementById('notAttendingCount').textContent = notAttending;
            document.getElementById('recentCount').textContent = recent;
            
            // Update recent count text to show email stats
            const recentCard = document.querySelector('.stat-card.recent p');
            if (recentCard && attendingRsvps.length > 0) {
                recentCard.innerHTML = `Last 24 Hours<br><small class="text-muted" style="font-size: 0.75rem;">Emails: ${emailsSent}/${attendingRsvps.length} sent</small>`;
            }
        }

        // Render table
        function renderTable() {
            const tbody = document.getElementById('rsvpTableBody');
            const emptyState = document.getElementById('emptyState');
            const tableContainer = document.getElementById('tableContainer');
            const noResults = document.getElementById('noResults');

            if (allRsvps.length === 0) {
                emptyState.classList.remove('d-none');
                tableContainer.classList.add('d-none');
                return;
            } else {
                emptyState.classList.add('d-none');
                tableContainer.classList.remove('d-none');
            }

            if (filteredRsvps.length === 0) {
                tbody.innerHTML = '';
                noResults.classList.remove('d-none');
                return;
            } else {
                noResults.classList.add('d-none');
            }

            tbody.innerHTML = filteredRsvps.map((rsvp, index) => {
                const date = new Date(rsvp.timestamp);
                const formattedDate = date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
                const attendBadge = rsvp.attend === 'yes' 
                    ? '<span class="badge badge-attending">Yes</span>' 
                    : '<span class="badge badge-not-attending">No</span>';
                
                // Email status indicator
                let emailStatus = '-';
                if (rsvp.attend === 'yes') {
                    if (rsvp.emailSent) {
                        const emailDate = rsvp.emailSentAt ? new Date(rsvp.emailSentAt).toLocaleString() : '';
                        emailStatus = `<span class="badge bg-success" title="Email sent at ${emailDate}"><i class="fas fa-check-circle me-1"></i>Sent</span>`;
                    } else if (rsvp.emailSent === false) {
                        emailStatus = '<span class="badge bg-danger" title="Email failed to send"><i class="fas fa-times-circle me-1"></i>Failed</span>';
                    } else {
                        // Old RSVPs without email tracking
                        emailStatus = '<span class="badge bg-secondary" title="Status unknown (old RSVP)"><i class="fas fa-question-circle me-1"></i>Unknown</span>';
                    }
                } else {
                    emailStatus = '<span class="badge bg-secondary" title="Not attending - no email sent">N/A</span>';
                }
                
                return `
                    <tr>
                        <td>${index + 1}</td>
                        <td><strong>${rsvp.name}</strong></td>
                        <td>${rsvp.email}</td>
                        <td>${rsvp.company || '-'}</td>
                        <td>${rsvp.role || '-'}</td>
                        <td>${attendBadge}</td>
                        <td>${emailStatus}</td>
                        <td>${rsvp.message ? `<span title="${rsvp.message}"><i class="fas fa-comment"></i></span>` : '-'}</td>
                        <td><small>${formattedDate}</small></td>
                        <td>
                            <button class="btn btn-sm btn-primary me-1" onclick="showEmailPreview('${rsvp.email}')" title="Send Email">
                                <i class="fas fa-envelope"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteRsvp('${rsvp.email}')" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Search functionality
        document.getElementById('searchBox').addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            applyFilters(searchTerm);
        });

        // Filter by attendance
        document.getElementById('filterAttendance').addEventListener('change', function(e) {
            const searchTerm = document.getElementById('searchBox').value.toLowerCase();
            applyFilters(searchTerm);
        });

        // Filter by email status
        document.getElementById('filterEmailStatus').addEventListener('change', function(e) {
            const searchTerm = document.getElementById('searchBox').value.toLowerCase();
            applyFilters(searchTerm);
        });

        // Apply filters
        function applyFilters(searchTerm = '') {
            const attendanceFilter = document.getElementById('filterAttendance').value;
            const emailFilter = document.getElementById('filterEmailStatus').value;
            
            filteredRsvps = allRsvps.filter(rsvp => {
                const matchesSearch = !searchTerm || 
                    rsvp.name.toLowerCase().includes(searchTerm) ||
                    rsvp.email.toLowerCase().includes(searchTerm) ||
                    (rsvp.company && rsvp.company.toLowerCase().includes(searchTerm)) ||
                    (rsvp.role && rsvp.role.toLowerCase().includes(searchTerm));
                
                const matchesAttendance = attendanceFilter === 'all' || rsvp.attend === attendanceFilter;
                
                let matchesEmail = true;
                if (emailFilter !== 'all') {
                    if (emailFilter === 'sent') {
                        matchesEmail = rsvp.emailSent === true;
                    } else if (emailFilter === 'failed') {
                        matchesEmail = rsvp.emailSent === false;
                    } else if (emailFilter === 'pending') {
                        matchesEmail = rsvp.attend === 'yes' && (rsvp.emailSent === undefined || rsvp.emailSent === null);
                    }
                }
                
                return matchesSearch && matchesAttendance && matchesEmail;
            });
            
            renderTable();
        }

        // Delete single RSVP
        function deleteRsvp(email) {
            if (confirm('Are you sure you want to delete this RSVP?')) {
                allRsvps = allRsvps.filter(r => r.email !== email);
                localStorage.setItem('rsvps', JSON.stringify(allRsvps));
                loadRsvps();
            }
        }

        // Clear all RSVPs
        function clearAllRSVPs() {
            if (confirm('Are you sure you want to delete ALL RSVPs? This action cannot be undone!')) {
                localStorage.removeItem('rsvps');
                loadRsvps();
            }
        }

        // Export to CSV
        function exportToCSV() {
            if (allRsvps.length === 0) {
                alert('No RSVPs to export!');
                return;
            }

            const headers = ['Name', 'Email', 'Company', 'Role', 'Attending', 'Email Sent', 'Email Sent At', 'Message', 'Timestamp'];
            const csvContent = [
                headers.join(','),
                ...allRsvps.map(rsvp => {
                    const emailStatus = rsvp.emailSent === true ? 'Yes' : rsvp.emailSent === false ? 'Failed' : 'N/A';
                    const emailSentAt = rsvp.emailSentAt || '';
                    return [
                        `"${rsvp.name}"`,
                        `"${rsvp.email}"`,
                        `"${rsvp.company || ''}"`,
                        `"${rsvp.role || ''}"`,
                        rsvp.attend === 'yes' ? 'Yes' : 'No',
                        emailStatus,
                        `"${emailSentAt}"`,
                        `"${(rsvp.message || '').replace(/"/g, '""')}"`,
                        `"${rsvp.timestamp}"`
                    ].join(',');
                })
            ].join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', `event-rsvps-${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Load data on page load
        document.addEventListener('DOMContentLoaded', loadRsvps);

        // Email template generation
        let currentEmailData = {};

        function generateEmailContent(rsvp) {
            const eventDate = 'November 15, 2025';
            const eventTime = '6:00 PM - 9:00 PM';
            const eventLocation = 'Innovation Hub, Davao City';
            const eventAddress = 'Innovation Hub Building, J.P. Laurel Ave, Davao City, 8000';
            
            return {
                subject: 'Confirmation: Networking Event for Startups - November 15, 2025',
                body: `Dear ${rsvp.name},

Thank you for registering for our Networking Event for Startups!

We're excited to confirm your attendance. Here are the event details:

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
EVENT DETAILS
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

📅 Date: ${eventDate}
🕐 Time: ${eventTime}
📍 Location: ${eventLocation}
🗺️  Address: ${eventAddress}

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
WHAT TO EXPECT
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

✨ Opening Keynote by a successful startup founder
💡 Panel Discussion on funding strategies
🤝 Structured networking activities
🚀 Startup Showcase presentations
🍷 Refreshments and drinks throughout the evening

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
YOUR REGISTRATION
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

Name: ${rsvp.name}
Email: ${rsvp.email}
${rsvp.company ? `Company: ${rsvp.company}` : ''}
${rsvp.role ? `Role: ${rsvp.role}` : ''}

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
IMPORTANT REMINDERS
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

• Please arrive 15 minutes early for registration
• Bring business cards for networking
• Dress code: Business casual
• Free parking is available at the venue

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

If you have any questions or need to update your registration, please don't hesitate to contact us at caesarsamulde@gmail.com or +639518023980.

We look forward to seeing you at the event!

Best regards,

Caesar Ian Samulde
Event Organizer
Frontend Developer & Graphic Designer

📧 caesarsamulde@gmail.com
📱 +639518023980
🌐 Portfolio: [Your Website]

P.S. Follow us on social media for event updates and announcements!`
            };
        }

        function showEmailPreview(email) {
            const rsvp = allRsvps.find(r => r.email === email);
            if (!rsvp) return;

            if (rsvp.attend !== 'yes') {
                if (!confirm('This person indicated they are NOT attending. Do you still want to send them an email?')) {
                    return;
                }
            }

            const emailContent = generateEmailContent(rsvp);
            currentEmailData = {
                to: rsvp.email,
                subject: emailContent.subject,
                body: emailContent.body
            };

            document.getElementById('emailTo').value = rsvp.email;
            document.getElementById('emailSubject').value = emailContent.subject;
            document.getElementById('emailPreview').innerHTML = emailContent.body.replace(/\n/g, '<br>');

            const modal = new bootstrap.Modal(document.getElementById('emailModal'));
            modal.show();
        }

        function showBulkEmailModal() {
            const attending = allRsvps.filter(r => r.attend === 'yes');
            
            if (attending.length === 0) {
                alert('No attendees to send emails to!');
                return;
            }

            if (confirm(`This will prepare emails for ${attending.length} attendee(s). Continue?`)) {
                // Generate email content for first attendee as preview
                const firstRsvp = attending[0];
                const emailContent = generateEmailContent(firstRsvp);
                
                currentEmailData = {
                    to: attending.map(r => r.email).join(', '),
                    subject: emailContent.subject,
                    body: emailContent.body,
                    isBulk: true,
                    count: attending.length
                };

                document.getElementById('emailTo').value = `${attending.length} recipient(s)`;
                document.getElementById('emailSubject').value = emailContent.subject;
                document.getElementById('emailPreview').innerHTML = 
                    `<p class="text-info"><strong>Preview for: ${firstRsvp.name}</strong></p>` + 
                    emailContent.body.replace(/\n/g, '<br>');

                const modal = new bootstrap.Modal(document.getElementById('emailModal'));
                modal.show();
            }
        }

        function copyEmailToClipboard() {
            const emailText = `To: ${currentEmailData.to}\nSubject: ${currentEmailData.subject}\n\n${currentEmailData.body}`;
            
            navigator.clipboard.writeText(emailText).then(() => {
                alert('Email content copied to clipboard! You can now paste it into your email client.');
            }).catch(err => {
                // Fallback for older browsers
                const textarea = document.createElement('textarea');
                textarea.value = emailText;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                alert('Email content copied to clipboard!');
            });
        }

        function openInEmailClient() {
            if (currentEmailData.isBulk) {
                alert('For bulk emails, please use the "Copy to Clipboard" option and paste into your email client with BCC for privacy.');
                return;
            }

            const subject = encodeURIComponent(currentEmailData.subject);
            const body = encodeURIComponent(currentEmailData.body);
            const mailtoLink = `mailto:${currentEmailData.to}?subject=${subject}&body=${body}`;
            
            window.location.href = mailtoLink;
        }
    </script>
</body>
</html>
